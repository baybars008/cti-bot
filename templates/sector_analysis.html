{% extends "base.html" %}

{% block title %}CTI-BOT Dashboard - Sektör Analizi{% endblock %}

{% block content %}
<!-- Sektör Analiz Başlığı -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="sector-name">Sektör Analizi</h1>
            <p class="text-gray-600" id="sector-description">Detaylı sektörel güvenlik analizi ve risk değerlendirmesi</p>
        </div>
        <div class="flex space-x-4">
            <button onclick="exportSectorData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Export</span>
            </button>
            <button onclick="goBack()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span>Geri</span>
            </button>
        </div>
    </div>
</div>

<!-- Sektör İstatistik Kartları -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Toplam Saldırı -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Toplam Saldırı</dt>
                        <dd class="text-lg font-medium text-gray-900" id="total-attacks">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Etkilenen Şirketler -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Etkilenen Şirketler</dt>
                        <dd class="text-lg font-medium text-gray-900" id="affected-companies">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Skoru -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Risk Skoru</dt>
                        <dd class="text-lg font-medium text-gray-900" id="risk-score">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Trend</dt>
                        <dd class="text-lg font-medium text-gray-900" id="trend">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ana Grafikler -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Sektörel Karşılaştırma -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Sektörel Karşılaştırma</h3>
        <div class="chart-container">
            <canvas id="sector-comparison-chart"></canvas>
        </div>
    </div>

    <!-- Zaman Çizelgesi -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Saldırı Trendleri</h3>
        <div class="chart-container">
            <canvas id="timeline-chart"></canvas>
        </div>
    </div>
</div>

<!-- Detaylı Analiz -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- En Riskli Alt Sektörler -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">En Riskli Alt Sektörler</h3>
        <div class="space-y-3" id="sub-sectors">
            <!-- Alt sektörler buraya eklenecek -->
        </div>
    </div>

    <!-- Tehdit Aktörü Dağılımı -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Tehdit Aktörü Dağılımı</h3>
        <div class="chart-container">
            <canvas id="threat-actor-chart"></canvas>
        </div>
    </div>

    <!-- Coğrafi Dağılım -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Coğrafi Dağılım</h3>
        <div class="space-y-3" id="geographic-distribution">
            <!-- Coğrafi dağılım buraya eklenecek -->
        </div>
    </div>
</div>

<!-- Sektördeki Şirketler -->
<div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-medium text-gray-900">Sektördeki Şirketler</h3>
        <div class="flex space-x-2">
            <select id="company-filter" class="px-3 py-1 text-sm border border-gray-300 rounded-md">
                <option value="all">Tüm Şirketler</option>
                <option value="high-risk">Yüksek Risk</option>
                <option value="recent">Son Saldırılar</option>
            </select>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Şirket</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Büyüklük</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Son Saldırı</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Seviyesi</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlemler</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="companies-table">
                <!-- Şirketler buraya eklenecek -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sectorData = null;

// Sayfa yüklendiğinde sektör verilerini yükle
document.addEventListener('DOMContentLoaded', function() {
    // URL'den sektör adını al
    const urlParams = new URLSearchParams(window.location.search);
    const sectorName = urlParams.get('sector');
    
    if (sectorName) {
        loadSectorData(sectorName);
    } else {
        // Mock data ile test
        loadMockData();
    }
});

// Sektör verilerini yükle
async function loadSectorData(sectorName) {
    try {
        const response = await fetch(`/api/sector-analysis/${sectorName}`);
        const data = await response.json();
        
        if (data.success) {
            sectorData = data.data;
            updateSectorInfo(sectorData);
            updateSubSectors(sectorData.sub_sectors);
            updateGeographicDistribution(sectorData.geographic);
            updateCompanies(sectorData.companies);
            createCharts(sectorData);
        } else {
            console.error('Sektör verileri yüklenemedi:', data.error);
            loadMockData();
        }
    } catch (error) {
        console.error('API hatası:', error);
        loadMockData();
    }
}

// Mock data ile test
function loadMockData() {
    sectorData = {
        name: 'Finans',
        description: 'Bankacılık ve finansal hizmetler sektörü',
        total_attacks: 234,
        affected_companies: 45,
        risk_score: 8.5,
        trend: 'Yükseliş',
        sub_sectors: [
            { name: 'Ticari Bankacılık', attacks: 120, risk: 'Yüksek' },
            { name: 'Yatırım Bankacılığı', attacks: 45, risk: 'Kritik' },
            { name: 'Sigorta', attacks: 35, risk: 'Orta' },
            { name: 'Fintech', attacks: 34, risk: 'Yüksek' }
        ],
        geographic: [
            { country: 'TR', attacks: 45, percentage: 19.2 },
            { country: 'US', attacks: 78, percentage: 33.3 },
            { country: 'UK', attacks: 34, percentage: 14.5 },
            { country: 'DE', attacks: 28, percentage: 12.0 },
            { country: 'FR', attacks: 25, percentage: 10.7 }
        ],
        companies: [
            { name: 'Türk Telekom A.Ş.', size: 'Büyük', last_attack: '2024-01-15', risk: 'Yüksek' },
            { name: 'ABC Bank', size: 'Orta', last_attack: '2024-01-10', risk: 'Kritik' },
            { name: 'XYZ Sigorta', size: 'Küçük', last_attack: '2023-12-20', risk: 'Orta' }
        ],
        threat_actors: {
            'LockBit': 45,
            'Conti': 38,
            'REvil': 32,
            'Maze': 28,
            'Ryuk': 25
        },
        timeline: {
            labels: ['2023-01', '2023-04', '2023-07', '2023-10', '2024-01'],
            data: [45, 52, 38, 67, 32]
        }
    };
    
    updateSectorInfo(sectorData);
    updateSubSectors(sectorData.sub_sectors);
    updateGeographicDistribution(sectorData.geographic);
    updateCompanies(sectorData.companies);
    createCharts(sectorData);
}

// Sektör bilgilerini güncelle
function updateSectorInfo(data) {
    document.getElementById('sector-name').textContent = `${data.name} Sektörü Analizi`;
    document.getElementById('sector-description').textContent = data.description;
    document.getElementById('total-attacks').textContent = data.total_attacks.toLocaleString();
    document.getElementById('affected-companies').textContent = data.affected_companies;
    document.getElementById('risk-score').textContent = `${data.risk_score}/10`;
    document.getElementById('trend').textContent = data.trend;
}

// Alt sektörleri güncelle
function updateSubSectors(subSectors) {
    const container = document.getElementById('sub-sectors');
    container.innerHTML = '';
    
    subSectors.forEach(sector => {
        const sectorDiv = document.createElement('div');
        sectorDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        sectorDiv.innerHTML = `
            <div>
                <p class="text-sm font-medium text-gray-900">${sector.name}</p>
                <p class="text-xs text-gray-500">${sector.attacks} saldırı</p>
            </div>
            <div class="text-right">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskClass(sector.risk)}">
                    ${sector.risk}
                </span>
            </div>
        `;
        container.appendChild(sectorDiv);
    });
}

// Coğrafi dağılımı güncelle
function updateGeographicDistribution(geographic) {
    const container = document.getElementById('geographic-distribution');
    container.innerHTML = '';
    
    geographic.forEach(item => {
        const geoDiv = document.createElement('div');
        geoDiv.className = 'flex justify-between items-center p-3 border rounded-lg';
        geoDiv.innerHTML = `
            <div>
                <p class="text-sm font-medium text-gray-900">${item.country}</p>
                <p class="text-xs text-gray-500">${item.attacks} saldırı</p>
            </div>
            <div class="text-right">
                <p class="text-sm font-medium text-gray-900">${item.percentage}%</p>
            </div>
        `;
        container.appendChild(geoDiv);
    });
}

// Şirketleri güncelle
function updateCompanies(companies) {
    const tbody = document.getElementById('companies-table');
    tbody.innerHTML = '';
    
    companies.forEach(company => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${company.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.size}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.last_attack}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(company.risk)}">
                    ${company.risk}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button onclick="viewCompany('${company.name}')" class="text-blue-600 hover:text-blue-800">
                    Detay
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Grafikleri oluştur
function createCharts(data) {
    createSectorComparisonChart(data);
    createTimelineChart(data);
    createThreatActorChart(data);
}

// Sektörel karşılaştırma grafiği
function createSectorComparisonChart(data) {
    const ctx = document.getElementById('sector-comparison-chart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Finans', 'Sağlık', 'Eğitim', 'Teknoloji', 'E-ticaret'],
            datasets: [{
                label: 'Saldırı Sayısı',
                data: [234, 189, 156, 134, 98],
                backgroundColor: [
                    '#ef4444', // Finans - Kırmızı
                    '#f59e0b', // Sağlık - Turuncu
                    '#10b981', // Eğitim - Yeşil
                    '#3b82f6', // Teknoloji - Mavi
                    '#8b5cf6'  // E-ticaret - Mor
                ],
                borderColor: [
                    '#dc2626',
                    '#d97706',
                    '#059669',
                    '#2563eb',
                    '#7c3aed'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Zaman çizelgesi grafiği
function createTimelineChart(data) {
    const ctx = document.getElementById('timeline-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.timeline.labels,
            datasets: [{
                label: 'Saldırı Sayısı',
                data: data.timeline.data,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Tehdit aktörü grafiği
function createThreatActorChart(data) {
    const ctx = document.getElementById('threat-actor-chart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data.threat_actors),
            datasets: [{
                data: Object.values(data.threat_actors),
                backgroundColor: [
                    '#ef4444',
                    '#f59e0b',
                    '#10b981',
                    '#3b82f6',
                    '#8b5cf6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Risk seviyesi CSS sınıfı
function getRiskClass(riskLevel) {
    switch(riskLevel) {
        case 'Düşük': return 'risk-low';
        case 'Orta': return 'risk-medium';
        case 'Yüksek': return 'risk-high';
        case 'Kritik': return 'risk-critical';
        default: return 'risk-medium';
    }
}

// Şirket detayını görüntüle
function viewCompany(companyName) {
    window.location.href = `/company-detail?name=${encodeURIComponent(companyName)}`;
}

// Export işlemi
function exportSectorData() {
    if (sectorData) {
        const data = {
            sector: sectorData.name,
            description: sectorData.description,
            total_attacks: sectorData.total_attacks,
            affected_companies: sectorData.affected_companies,
            risk_score: sectorData.risk_score,
            trend: sectorData.trend,
            sub_sectors: sectorData.sub_sectors,
            geographic: sectorData.geographic,
            companies: sectorData.companies,
            threat_actors: sectorData.threat_actors
        };
        
        const jsonContent = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${sectorData.name.replace(/\s+/g, '_')}_analysis.json`;
        a.click();
        window.URL.revokeObjectURL(url);
    }
}

// Geri dön
function goBack() {
    window.history.back();
}
</script>
{% endblock %}

