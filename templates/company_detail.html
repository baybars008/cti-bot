{% extends "base.html" %}

{% block title %}CTI-BOT Dashboard - Şirket Detayı{% endblock %}

{% block content %}
<!-- Şirket Detay Başlığı -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="company-name">Şirket Adı</h1>
            <p class="text-gray-600" id="company-description">Şirket detay bilgileri</p>
        </div>
        <div class="flex space-x-4">
            <button onclick="exportCompanyData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>Export</span>
            </button>
            <button onclick="goBack()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span>Geri</span>
            </button>
        </div>
    </div>
</div>

<!-- Şirket Bilgi Kartları -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Sektör -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Sektör</dt>
                        <dd class="text-lg font-medium text-gray-900" id="company-sector">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Ülke -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Ülke</dt>
                        <dd class="text-lg font-medium text-gray-900" id="company-country">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Şirket Büyüklüğü -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Büyüklük</dt>
                        <dd class="text-lg font-medium text-gray-900" id="company-size">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Seviyesi -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Risk Seviyesi</dt>
                        <dd class="text-lg font-medium text-gray-900" id="company-risk">-</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ana İçerik -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Saldırı Geçmişi -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Saldırı Geçmişi</h3>
        <div class="space-y-4" id="attack-history">
            <!-- Saldırı kayıtları buraya eklenecek -->
        </div>
    </div>

    <!-- Sektörel Karşılaştırma -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Sektörel Karşılaştırma</h3>
        <div class="chart-container">
            <canvas id="sector-comparison-chart"></canvas>
        </div>
    </div>
</div>

<!-- Detaylı Analiz -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- Tehdit Aktörü Analizi -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Tehdit Aktörü Analizi</h3>
        <div class="space-y-3" id="threat-actor-analysis">
            <!-- Tehdit aktörü bilgileri buraya eklenecek -->
        </div>
    </div>

    <!-- Zaman Çizelgesi -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Saldırı Zaman Çizelgesi</h3>
        <div class="chart-container">
            <canvas id="timeline-chart"></canvas>
        </div>
    </div>

    <!-- Risk Faktörleri -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Risk Faktörleri</h3>
        <div class="space-y-4" id="risk-factors">
            <!-- Risk faktörleri buraya eklenecek -->
        </div>
    </div>
</div>

<!-- İlgili Şirketler -->
<div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Benzer Şirketler</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Şirket</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sektör</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Son Saldırı</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Seviyesi</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlemler</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="similar-companies-table">
                <!-- Benzer şirketler buraya eklenecek -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let companyId = null;
let companyData = null;

// Sayfa yüklendiğinde şirket verilerini yükle
document.addEventListener('DOMContentLoaded', function() {
    // URL'den şirket adını al
    const urlParams = new URLSearchParams(window.location.search);
    const companyName = urlParams.get('name');
    
    if (companyName) {
        loadCompanyDataByName(companyName);
    } else {
        // Mock data sadece veri yoksa gösterilir
        loadMockData();
    }
});

// Şirket verilerini isim ile yükle
async function loadCompanyDataByName(companyName) {
    try {
        const response = await fetch(`/api/company-detail?name=${encodeURIComponent(companyName)}`);
        const data = await response.json();
        
        if (data.success) {
            companyData = data.data;
            updateCompanyInfo(companyData);
            updateAttackHistory(companyData.attacks);
            updateThreatActorAnalysis(companyData.threat_actors);
            updateRiskFactors(companyData.risk_factors);
            updateSimilarCompanies(companyData.similar_companies);
            createCharts(companyData);
        } else {
            console.error('Şirket verileri yüklenemedi:', data.error);
            loadMockData();
        }
    } catch (error) {
        console.error('API hatası:', error);
        loadMockData();
    }
}

// Mock data ile test
function loadMockData() {
    companyData = {
        name: 'Türk Telekom A.Ş.',
        sector: 'Telekomünikasyon',
        country: 'TR',
        size: 'Büyük',
        risk_level: 'Yüksek',
        description: 'Türkiye\'nin önde gelen telekomünikasyon şirketi',
        attacks: [
            {
                date: '2024-01-15',
                threat_actor: 'LockBit',
                impact: 'Yüksek',
                description: 'Müşteri verileri sızıntısı'
            },
            {
                date: '2023-08-22',
                threat_actor: 'Conti',
                impact: 'Orta',
                description: 'Sistem erişim ihlali'
            }
        ],
        threat_actors: [
            { name: 'LockBit', attacks: 2, last_seen: '2024-01-15' },
            { name: 'Conti', attacks: 1, last_seen: '2023-08-22' }
        ],
        risk_factors: [
            { factor: 'Büyük şirket', risk: 'Yüksek' },
            { factor: 'Kritik altyapı', risk: 'Kritik' },
            { factor: 'Hassas veri', risk: 'Yüksek' }
        ],
        similar_companies: [
            { name: 'Vodafone Türkiye', sector: 'Telekomünikasyon', last_attack: '2023-12-10', risk: 'Orta' },
            { name: 'Turkcell', sector: 'Telekomünikasyon', last_attack: '2023-11-05', risk: 'Yüksek' }
        ]
    };
    
    updateCompanyInfo(companyData);
    updateAttackHistory(companyData.attacks);
    updateThreatActorAnalysis(companyData.threat_actors);
    updateRiskFactors(companyData.risk_factors);
    updateSimilarCompanies(companyData.similar_companies);
    createCharts(companyData);
}

// Şirket bilgilerini güncelle
function updateCompanyInfo(data) {
    document.getElementById('company-name').textContent = data.name;
    document.getElementById('company-description').textContent = data.description || 'Detay bilgi mevcut değil';
    document.getElementById('company-sector').textContent = data.sector;
    document.getElementById('company-country').textContent = data.country;
    document.getElementById('company-size').textContent = data.size;
    document.getElementById('company-risk').textContent = data.risk_level;
}

// Saldırı geçmişini güncelle
function updateAttackHistory(attacks) {
    const container = document.getElementById('attack-history');
    container.innerHTML = '';
    
    attacks.forEach(attack => {
        const attackDiv = document.createElement('div');
        attackDiv.className = 'border-l-4 border-red-500 pl-4 py-2';
        attackDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-900">${attack.threat_actor}</p>
                    <p class="text-sm text-gray-500">${attack.description}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">${attack.date}</p>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskClass(attack.impact)}">
                        ${attack.impact}
                    </span>
                </div>
            </div>
        `;
        container.appendChild(attackDiv);
    });
}

// Tehdit aktörü analizini güncelle
function updateThreatActorAnalysis(threatActors) {
    const container = document.getElementById('threat-actor-analysis');
    container.innerHTML = '';
    
    threatActors.forEach(actor => {
        const actorDiv = document.createElement('div');
        actorDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        actorDiv.innerHTML = `
            <div>
                <p class="text-sm font-medium text-gray-900">${actor.name}</p>
                <p class="text-xs text-gray-500">Son görülme: ${actor.last_seen}</p>
            </div>
            <div class="text-right">
                <p class="text-sm font-medium text-gray-900">${actor.attacks} saldırı</p>
            </div>
        `;
        container.appendChild(actorDiv);
    });
}

// Risk faktörlerini güncelle
function updateRiskFactors(riskFactors) {
    const container = document.getElementById('risk-factors');
    container.innerHTML = '';
    
    riskFactors.forEach(factor => {
        const factorDiv = document.createElement('div');
        factorDiv.className = 'flex justify-between items-center p-3 border rounded-lg';
        factorDiv.innerHTML = `
            <span class="text-sm text-gray-900">${factor.factor}</span>
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskClass(factor.risk)}">
                ${factor.risk}
            </span>
        `;
        container.appendChild(factorDiv);
    });
}

// Benzer şirketleri güncelle
function updateSimilarCompanies(companies) {
    const tbody = document.getElementById('similar-companies-table');
    tbody.innerHTML = '';
    
    companies.forEach(company => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${company.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.sector}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.last_attack}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(company.risk)}">
                    ${company.risk}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button onclick="viewCompany('${company.name}')" class="text-blue-600 hover:text-blue-800">
                    Detay
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Grafikleri oluştur
function createCharts(data) {
    createSectorComparisonChart(data);
    createTimelineChart(data);
}

// Sektörel karşılaştırma grafiği
function createSectorComparisonChart(data) {
    const ctx = document.getElementById('sector-comparison-chart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Bu Şirket', 'Sektör Ortalaması', 'En Yüksek Risk'],
            datasets: [{
                label: 'Risk Skoru',
                data: [8, 5, 9], // Mock data
                backgroundColor: ['#ef4444', '#f59e0b', '#dc2626'],
                borderColor: ['#dc2626', '#d97706', '#b91c1c'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10
                }
            }
        }
    });
}

// Zaman çizelgesi grafiği
function createTimelineChart(data) {
    const ctx = document.getElementById('timeline-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['2023-01', '2023-04', '2023-07', '2023-10', '2024-01'],
            datasets: [{
                label: 'Saldırı Sayısı',
                data: [0, 1, 0, 0, 1],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Risk seviyesi CSS sınıfı
function getRiskClass(riskLevel) {
    switch(riskLevel) {
        case 'Düşük': return 'risk-low';
        case 'Orta': return 'risk-medium';
        case 'Yüksek': return 'risk-high';
        case 'Kritik': return 'risk-critical';
        default: return 'risk-medium';
    }
}

// Şirket detayını görüntüle
function viewCompany(companyName) {
    window.location.href = `/company-detail?name=${encodeURIComponent(companyName)}`;
}

// Export işlemi
function exportCompanyData() {
    if (companyData) {
        const data = {
            company: companyData.name,
            sector: companyData.sector,
            country: companyData.country,
            size: companyData.size,
            risk_level: companyData.risk_level,
            attacks: companyData.attacks,
            threat_actors: companyData.threat_actors,
            risk_factors: companyData.risk_factors
        };
        
        const jsonContent = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${companyData.name.replace(/\s+/g, '_')}_detail.json`;
        a.click();
        window.URL.revokeObjectURL(url);
    }
}

// Geri dön
function goBack() {
    window.history.back();
}
</script>
{% endblock %}
